# =========================================================================
# CRS SETUP - 
# =========================================================================
#
# Este archivo configura el CRS, no el motor Coraza.
# Las directivas SecRuleEngine, SecRequestBodyAccess, etc. se configuran 
# en el config.yml de Coraza SPOA.

# FASE 1: Configuración de Variables Globales (Setup)
# ------------------------------------------------------------------------

# 900000 - Definición del Nivel de Paranoia (PL)
# PL1 es recomendado para empezar (bajo riesgo de Falsos Positivos)
SecAction \
    "id:900000,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    tag:'OWASP_CRS',\
    ver:'OWASP_CRS/4.20.0',\
    setvar:tx.blocking_paranoia_level=1"

# 900110 - Umbrales de Bloqueo (Anomaly Scoring)
# Umbral de Inbound (Bloqueo de Petición): 5 asegura que un ataque grave bloquee la petición.
# Umbral de Outbound (Bloqueo de Respuesta): 4 asegura que una fuga de datos bloquee la respuesta.
SecAction \
    "id:900110,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    tag:'OWASP_CRS',\
    ver:'OWASP_CRS/4.20.0',\
    setvar:tx.inbound_anomaly_score_threshold=5,\
    setvar:tx.outbound_anomaly_score_threshold=4"

# 900010 - Forzar procesador URLENCODED
# Recomendado para cerrar vectores de bypass, especialmente si tu API no siempre 
# declara Content-Type en formularios POST.
SecAction \
    "id:900010,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    tag:'OWASP_CRS',\
    ver:'OWASP_CRS/4.20.0',\
    setvar:tx.enforce_bodyproc_urlencoded=1"

# 900950 - Validación de UTF-8
# Activa la validación estricta de codificación de caracteres.
SecAction \
    "id:900950,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    tag:'OWASP_CRS',\
    ver:'OWASP_CRS/4.20.0',\
    setvar:tx.crs_validate_utf8_encoding=1"


# FASE 2: Política HTTP y Límites
# ------------------------------------------------------------------------

# 900200 - Métodos HTTP Permitidos (API RESTful Completa)
# Descomenta los métodos que necesites (ej. PUT, DELETE, PATCH).
SecAction \
    "id:900200,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    tag:'OWASP_CRS',\
    ver:'OWASP_CRS/4.20.0',\
    setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT PATCH DELETE'"

# 900220 - Content-Types Permitidos
# Asegúrate de incluir 'application/json' para tu API.
SecAction \
    "id:900220,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    tag:'OWASP_CRS',\
    ver:'OWASP_CRS/4.20.0',\
    setvar:'tx.allowed_request_content_type=|application/x-www-form-urlencoded| |multipart/form-data| |text/xml| |application/xml| |application/soap+xml| |application/json| |application/reports+json| |application/csp-report|'"

# 900330 - Límite de Longitud Total de Argumentos
# Límite a 64KB (64000). Necesario para prevenir ataques DoS por argumentos muy grandes.
SecAction \
    "id:900330,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    tag:'OWASP_CRS',\
    ver:'OWASP_CRS/4.20.0',\
    setvar:tx.total_arg_length=64000"

# 900990 - FIN DEL SETUP
# Esta variable es esencial para que Coraza sepa que el setup ha terminado.
SecAction \
    "id:900990,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    tag:'OWASP_CRS',\
    ver:'OWASP_CRS/4.20.0',\
    setvar:tx.crs_setup_version=4200"
